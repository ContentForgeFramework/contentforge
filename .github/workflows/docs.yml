name: Deploy Documentation

on:
    push:
        branches:
            - main
        paths:
            - '**/*.md'
            - 'docs/**'
            - 'mkdocs.yml'
            - '.github/workflows/deploy_docs.yml'
    workflow_dispatch:     # 可选：手动部署

jobs:
    deploy:
        runs-on: ubuntu-latest

        # 可选：缓存 Poetry & pip
        steps:
            -   uses: actions/cache@v3
                with:
                    path: ~/.cache/pypoetry
                    key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
            -   uses: actions/cache@v3
                with:
                    path: ~/.cache/pip
                    key: ${{ runner.os }}-pip-${{ hashFiles('**/poetry.lock') }}

            -   name: Checkout repository
                uses: actions/checkout@v3

            # 推荐：用官方安装脚本或 setup-poetry
            -   name: Install Poetry
                run: |
                    curl -sSL https://install.python-poetry.org | python3 -
                    echo "::add-path::$HOME/.local/bin"

            -   name: Install dependencies
                run: |
                    poetry config virtualenvs.create false
                    poetry install --with doc

            -   name: Build Documentation with MkDocs
                run: mkdocs build

            -   name: Deploy to GitHub Pages
                uses: peaceiris/actions-gh-pages@v3
                with:
                    github_token: ${{ secrets.GITHUB_TOKEN }}
                    publish_dir: ./site
                    allow_empty_commit: true       # 可选：避免无改动时失败
